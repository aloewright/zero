name: Ampcode PR Review

on:
  pull_request_target:
    types: [opened, ready_for_review, synchronize]
    branches: [main, staging]
  issue_comment:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  ampcode-review:
    if: github.event_name == 'pull_request_target' && github.event.pull_request.draft == false
    timeout-minutes: 15
    runs-on: ${{ vars.RUNNER_IMAGE || 'ubuntu-latest' }}
    strategy:
      matrix:
        review-chunk: [1]
      max-parallel: 3

    steps:
      - name: Set PR context
        id: pr-context
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "pr_sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          echo "pr_base_ref=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
          echo "trigger_type=automatic" >> $GITHUB_OUTPUT

      - name: Checkout base branch (trusted)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base
          fetch-depth: 0

      - name: Checkout PR branch (untrusted, no execution)
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-context.outputs.pr_sha }}
          path: pr
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2'

      - name: Install Ampcode CLI
        run: |
          bunx --bun @sourcegraph/amp --version

      - name: Get changed files
        id: changed-files
        run: |
          cd pr
          git fetch origin --prune
          mapfile -t changed_files < <(git diff --name-only origin/${{ steps.pr-context.outputs.pr_base_ref }}..HEAD | grep -E '\.(ts|tsx|js|jsx|py|go|java|cpp|c|h|hpp|rs|rb|php|cs|swift|kt|scala|clj|hs|ml|fs|elm|dart|lua|r|sql|sh|bash|zsh|fish|ps1|bat|cmd|yaml|yml|json|toml|ini|cfg|conf|xml|html|css|scss|sass|less|styl|vue|svelte|astro|md|mdx|tex|latex|bib|org|rst|adoc|asciidoc|wiki|txt)$' | head -50)
          printf '%s\n' "${changed_files[@]}" > ../changed_files.txt
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          printf '%s\n' "${changed_files[@]}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Changed files count: ${#changed_files[@]}"



      - name: Run Ampcode Review
        if: steps.changed-files.outputs.changed_files != '' && github.event.pull_request.head.repo.full_name == github.repository
        env:
          AMP_API_KEY: ${{ secrets.AMPCODE_API_KEY }}
        run: |
          echo "Running ampcode review on changed files..."

          mapfile -t files < changed_files.txt
          
          if [ ${#files[@]} -eq 0 ]; then
            echo "No files to review"
            exit 0
          fi

          # Use proper quoting to prevent injection
          REVIEW_OUTPUT=$(bunx --bun @sourcegraph/amp -x "Review the following files for code quality, potential bugs, security issues, performance concerns, and best practices. For each issue found, provide the specific file path and line number where the issue occurs. Format your response as: FILE:line_number:issue_description. Focus on providing specific, actionable feedback with exact line numbers. Files to review: ${files[*]@Q}" 2>&1 || echo "Ampcode review failed")

          echo "$REVIEW_OUTPUT" > ampcode_review.txt

          echo "=== Ampcode Review Output ==="
          cat ampcode_review.txt
          echo "=== End Review Output ==="

      - name: Parse and Post Comments with Python
        if: steps.changed-files.outputs.changed_files != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ steps.pr-context.outputs.pr_sha }}
        run: |
          if [ ! -f ampcode_review.txt ] || [ ! -s ampcode_review.txt ]; then
            echo "No review output found or file is empty"
            exit 0
          fi

          # Run Python script to parse review and create payloads
          python3 base/.github/scripts/parse_review_comments.py

          # Check if we have inline comments
          if [ -f review_payload.json ]; then
            echo "Posting review with inline comments..."
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              -d @review_payload.json \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ steps.pr-context.outputs.pr_number }}/reviews")

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n -1)
            if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
              echo "Posted review with inline comments successfully"
            else
              echo "Posting review failed (HTTP $http_code): $body"
              exit 1
            fi
          elif [ -f total_chunks.txt ]; then
            # Post fallback chunked comments
            TOTAL_CHUNKS=$(cat total_chunks.txt)
            echo "Posting $TOTAL_CHUNKS fallback comment(s)..."
            
            for i in $(seq 1 $TOTAL_CHUNKS); do
              if [ -f "review_comment_$i.json" ]; then
                curl -X POST \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "Content-Type: application/json" \
                  -d @"review_comment_$i.json" \
                  "https://api.github.com/repos/${{ github.repository }}/pulls/${{ steps.pr-context.outputs.pr_number }}/reviews"
                
                echo "Posted review comment part $i/$TOTAL_CHUNKS"
                sleep 1
              fi
            done
          else
            echo "No review payload or chunks generated"
            exit 1
          fi

  ampcode-review-manual:
    if: github.event_name == 'issue_comment' && github.event.issue.pull_request && (contains(github.event.comment.body, '/amp') || contains(github.event.comment.body, '/review'))
    timeout-minutes: 15
    runs-on: ${{ vars.RUNNER_IMAGE || 'ubuntu-latest' }}

    steps:
      - name: Check if comment triggers review
        id: check-pr
        env:
          BODY: ${{ github.event.comment.body }}
        run: |
          if [[ "$BODY" == *"/amp"* ]] || [[ "$BODY" == *"/review"* ]]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Set PR context
        if: steps.check-pr.outputs.is_pr == 'true'
        id: pr-context
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number="${{ github.event.issue.number }}"
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT

          pr_info=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number")

          pr_sha=$(echo "$pr_info" | jq -r '.head.sha')
          pr_base_ref=$(echo "$pr_info" | jq -r '.base.ref')

          echo "pr_sha=$pr_sha" >> $GITHUB_OUTPUT
          echo "pr_base_ref=$pr_base_ref" >> $GITHUB_OUTPUT
          echo "trigger_type=manual" >> $GITHUB_OUTPUT
          echo "comment_author=${{ github.event.comment.user.login }}" >> $GITHUB_OUTPUT

      - name: Checkout base branch (trusted)
        if: steps.check-pr.outputs.is_pr == 'true'
        uses: actions/checkout@v4
        with:
          ref: main
          path: base
          fetch-depth: 0

      - name: Checkout PR branch (untrusted, no execution)
        if: steps.check-pr.outputs.is_pr == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-context.outputs.pr_sha }}
          path: pr
          persist-credentials: false
          fetch-depth: 0

      - name: Setup Bun
        if: steps.check-pr.outputs.is_pr == 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.2'

      - name: Install Ampcode CLI
        if: steps.check-pr.outputs.is_pr == 'true'
        run: |
          bunx --bun @sourcegraph/amp --version

      - name: Get changed files
        if: steps.check-pr.outputs.is_pr == 'true'
        id: changed-files
        run: |
          cd pr
          git fetch origin --prune
          mapfile -t changed_files < <(git diff --name-only origin/${{ steps.pr-context.outputs.pr_base_ref }}..HEAD | grep -E '\.(ts|tsx|js|jsx|py|go|java|cpp|c|h|hpp|rs|rb|php|cs|swift|kt|scala|clj|hs|ml|fs|elm|dart|lua|r|sql|sh|bash|zsh|fish|ps1|bat|cmd|yaml|yml|json|toml|ini|cfg|conf|xml|html|css|scss|sass|less|styl|vue|svelte|astro|md|mdx|tex|latex|bib|org|rst|adoc|asciidoc|wiki|txt)$' | head -50)
          printf '%s\n' "${changed_files[@]}" > ../changed_files.txt
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          printf '%s\n' "${changed_files[@]}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Changed files count: ${#changed_files[@]}"



      - name: Run Ampcode Review
        if: steps.check-pr.outputs.is_pr == 'true' && steps.changed-files.outputs.changed_files != ''
        env:
          AMP_API_KEY: ${{ secrets.AMPCODE_API_KEY }}
        run: |
          echo "Running ampcode review on changed files..."

          mapfile -t files < changed_files.txt
          
          if [ ${#files[@]} -eq 0 ]; then
            echo "No files to review"
            exit 0
          fi

          # Use proper quoting to prevent injection
          REVIEW_OUTPUT=$(bunx --bun @sourcegraph/amp -x "Review the following files for code quality, potential bugs, security issues, performance concerns, and best practices. For each issue found, provide the specific file path and line number where the issue occurs. Format your response as: FILE:line_number:issue_description. Focus on providing specific, actionable feedback with exact line numbers. Files to review: ${files[*]@Q}" 2>&1 || echo "Ampcode review failed")

          echo "$REVIEW_OUTPUT" > ampcode_review.txt

          echo "=== Ampcode Review Output ==="
          cat ampcode_review.txt
          echo "=== End Review Output ==="

      - name: Parse and Post Comments with Python
        if: steps.check-pr.outputs.is_pr == 'true' && steps.changed-files.outputs.changed_files != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ steps.pr-context.outputs.pr_sha }}
        run: |
          if [ ! -f ampcode_review.txt ] || [ ! -s ampcode_review.txt ]; then
            echo "No review output found or file is empty"
            exit 0
          fi

          # Run Python script to parse review and create payloads
          python3 base/.github/scripts/parse_review_comments.py

          # Check if we have inline comments
          if [ -f review_payload.json ]; then
            echo "Posting review with inline comments..."
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json" \
              -d @review_payload.json \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ steps.pr-context.outputs.pr_number }}/reviews")

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n -1)
            if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
              echo "Posted review with inline comments successfully"
            else
              echo "Posting review failed (HTTP $http_code): $body"
              exit 1
            fi
          elif [ -f total_chunks.txt ]; then
            # Post fallback chunked comments
            TOTAL_CHUNKS=$(cat total_chunks.txt)
            echo "Posting $TOTAL_CHUNKS fallback comment(s)..."
            
            for i in $(seq 1 $TOTAL_CHUNKS); do
              if [ -f "review_comment_$i.json" ]; then
                curl -X POST \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "Content-Type: application/json" \
                  -d @"review_comment_$i.json" \
                  "https://api.github.com/repos/${{ github.repository }}/pulls/${{ steps.pr-context.outputs.pr_number }}/reviews"
                
                echo "Posted review comment part $i/$TOTAL_CHUNKS"
                sleep 1
              fi
            done
          else
            echo "No review payload or chunks generated"
            exit 1
          fi
